name: Force Merge PRs to Main (Overwrite Mode)

on:
  schedule:
    - cron: '0 * * * *' # æ¯å°æ—¶è¿è¡Œ
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write
  pull-requests: write

jobs:
  force-merge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: main         # ç›´æ¥æ£€å‡º main åˆ†æ”¯
          fetch-depth: 0    #ä»¥æ­¤è·å–å®Œæ•´å†å²ï¼Œæ–¹ä¾¿åˆå¹¶
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git Identity
        run: |
          git config --global user.name "Auto Merge Bot"
          git config --global user.email "bot@example.com"

      - name: Fetch PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # è·å–æ‰€æœ‰ Open çŠ¶æ€çš„ PR ç¼–å·
          gh pr list --state open --json number --jq '.[].number' > pr_numbers.txt
          echo "å¾…å¤„ç†çš„ PR åˆ—è¡¨:"
          cat pr_numbers.txt

      - name: Merge PRs (Theirs Wins)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ç¡®ä¿æˆ‘ä»¬åœ¨ main åˆ†æ”¯
          git checkout main

          while read number; do
            echo "=========================================="
            echo "Processing PR #$number"
            
            # 1. æ£€å‡º PR åˆ°æœ¬åœ°çš„ä¸€ä¸ªä¸´æ—¶åˆ†æ”¯
            # gh pr checkout ä¼šè‡ªåŠ¨æŠŠ PR æ‹‰å–ä¸ºæœ¬åœ°åˆ†æ”¯
            gh pr checkout $number
            PR_BRANCH=$(git branch --show-current)
            echo "PR Branch Name: $PR_BRANCH"
            
            # 2. åˆ‡å› Main å‡†å¤‡åˆå¹¶
            git checkout main
            
            # 3. ã€æ ¸å¿ƒæ­¥éª¤ã€‘åˆå¹¶å¹¶å¼ºåˆ¶è¦†ç›–
            # --no-ff: å¼ºåˆ¶ç”Ÿæˆåˆå¹¶æäº¤èŠ‚ç‚¹ï¼Œæ–¹ä¾¿å›æº¯
            # -X theirs: é‡åˆ°å†²çªæ—¶ï¼Œæ— æ¡ä»¶ä½¿ç”¨â€œä»–ä»¬çš„â€(å³ PR åˆ†æ”¯)çš„å†…å®¹ï¼Œä¸¢å¼ƒ main çš„å†²çªå†…å®¹
            echo "Merging $PR_BRANCH into main with strategy 'theirs'..."
            
            if git merge --no-ff -X theirs "$PR_BRANCH" -m "Auto merge PR #$number (Force Overwrite)"; then
              echo "âœ… Merge successful."
              
              # 4. æ¨é€åˆ°è¿œç¨‹ Main
              # æ³¨æ„ï¼šå¦‚æœè¿™æœŸé—´æœ‰äººæäº¤äº†ä»£ç ï¼Œå¯èƒ½éœ€è¦ pullï¼Œè¿™é‡Œç›´æ¥ push
              git push origin main
              echo "ğŸš€ Pushed to main."
              
              # å¯é€‰ï¼šåˆå¹¶åå…³é—­ PR (å¦‚æœä½ æƒ³å…³æ‰å®ƒ)
              # gh pr close $number --comment "Auto merged via workflow."
            else
              echo "âŒ Merge failed for some reason. Aborting this merge."
              git merge --abort
            fi

          done < pr_numbers.txt
