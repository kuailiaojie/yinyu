name: Auto Rebase All PRs

on:
  workflow_dispatch:  # 可以手动触发
  schedule:          # 可选：每天定时触发一次
    - cron: '0 0 * * *'

jobs:
  rebase_all_prs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # 获取完整历史

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Get all open PRs
        id: prs
        run: |
          pr_list=$(gh pr list --state open --json number,headRefName --jq '.[] | "\(.number) \(.headRefName)"')
          echo "$pr_list" > pr_list.txt
          echo "::set-output name=pr_list::$pr_list"

      - name: Rebase each PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          while read pr_number pr_branch; do
            echo "Processing PR #$pr_number branch: $pr_branch"
            git fetch origin $pr_branch
            git checkout $pr_branch

            # 自动 rebase，遇冲突使用 PR 的内容
            git fetch origin main
            git rebase -X theirs origin/main || true

            # push 回远程
            git push -f origin $pr_branch
          done < pr_list.txt
